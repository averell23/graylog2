upstream unicorn_server {
      <% if @use_socket %>
      # primary connection, "fail_timeout=0" is to ensure that
      # we always *try* to use the UNIX socket on every request
      # that comes in:
        server unix:<%= @unicorn_socket %> fail_timeout=0;
      # failover connections, "backup" ensures these will not
      # be used unless connections to unix:/tmp/sock are failing
      # it may be advisable to reorder these on a per-host basis
      # so "host1" does not connect to "host1_private" as its
      # first choice...
      <% end %>
      <% @ippool.each do |ip| %>
        server <%= ip %>:<%= @unicorn_port %> fail_timeout=0 <% if @use_socket %> backup <% end %>;
      <% end %>

    }